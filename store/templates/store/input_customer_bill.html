{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}‡∫™‡ªâ‡∫≤‡∫á‡∫ö‡∫¥‡∫ô‡ªÉ‡ªù‡ªà (Input Bill){% endblock %}

{% block content %}
<div class="max-w-[1800px] mx-auto bg-white p-4 md:p-8 rounded-xl shadow-sm border border-gray-100">
    <!-- Branding Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 pb-6 border-b-4 border-red-600 gap-6">
        <div class="flex flex-col md:flex-row items-center gap-6">

            <div class="text-center md:text-left">
                <img src="{% static 'images/k-auto-logo.JPG' %}" alt="K-Auto Logo" class="h-20 object-cover rounded-lg mb-2">
                <p class="text-gray-500 font-medium text-sm">‡∫ß‡∫¥‡∫™‡∫≤‡∫´‡∫∞‡∫Å‡∫¥‡∫î‡∫™‡ªà‡∫ß‡∫ô‡∫ö‡∫∏‡∫Å‡∫Ñ‡∫ª‡∫ô‡∫≠‡∫π‡ªà‡∫™‡ªâ‡∫≠‡∫°‡ªÅ‡∫õ‡∫á‡∫•‡∫ª‡∫î ‡ªÄ‡∫Ñ‡ªÄ‡∫≠‡ªÇ‡∫ï‡ªâ‡∫•‡∫≤‡∫ß ‡ªÄ‡∫ä‡∫µ‡∫ß‡∫¥‡∫™</p>
                <div class="flex flex-wrap justify-center md:justify-start gap-x-4 gap-y-1 mt-2 text-gray-400 text-xs">
                    <span class="flex items-center gap-1"><i class="fas fa-map-marker-alt text-red-500"></i> ‡∫ö‡ªâ‡∫≤‡∫ô‡∫ô‡∫≤‡ªÄ‡∫•‡∫ª‡ªà‡∫≤ ‡ªÄ‡∫°‡∫∑‡∫≠‡∫á‡ªÑ‡∫Å‡∫™‡∫≠‡∫ô‡∫û‡∫ª‡∫°‡∫ß‡∫¥‡∫´‡∫≤‡∫ô ‡ªÅ‡∫Ç‡∫ß‡∫á‡∫™‡∫∞‡∫´‡∫ß‡∫±‡∫ô‡∫ô‡∫∞‡ªÄ‡∫Ç‡∫î</span>
                    <span class="flex items-center gap-1"><i class="fas fa-phone-alt text-green-500"></i> +856 20 96966610 / 96964449</span>
                </div>
            </div>
        </div>
        <div class="text-right flex flex-col items-end gap-2">
            <h2 class="text-3xl font-black text-red-600 lg:tracking-wide">‡ªÉ‡∫ö‡∫ö‡∫¥‡∫ô / INVOICE</h2>
            <div class="flex flex-col items-end gap-1">
                <p class="text-gray-600 font-bold">‡∫ß‡∫±‡∫ô‡∫ó‡∫µ: <span class="text-blue-600 underline">{% now "d-M-Y" %}</span></p>
                <p class="text-xs font-bold px-3 py-1 bg-gray-100 text-gray-500 rounded-full border border-gray-200 uppercase tracking-tighter">AUTO-GEN</p>
            </div>
        </div>
    </div>

    <form id="billForm">
        <!-- Section 1: Customer & Car Info -->
        <div class="mb-10">
            <div class="bg-gray-100 px-4 py-2 font-bold text-gray-800 border-l-4 border-red-600 mb-6 flex items-center gap-2">
                <i class="fas fa-user-tag text-red-600"></i> ‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤ ‡ªÅ‡∫•‡∫∞ ‡∫•‡∫ª‡∫î / Customer & Vehicle Information
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-12 gap-6 mb-6">
                <!-- Customer Name Search -->
                <div class="md:col-span-8 flex flex-col gap-1.5 relative">
                    <label class="block text-sm font-bold text-gray-700">‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤ / Customer</label>
                    <div class="relative">
                        <input type="text" id="cust_name" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none transition-all" placeholder="üîç ‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤‡∫ä‡∫∑‡ªà ‡∫´‡∫º‡∫∑ ‡ªÄ‡∫ö‡∫µ‡ªÇ‡∫ó..." autocomplete="off">
                        <div id="cust_autocomplete" class="hidden absolute top-full left-0 right-0 bg-white border border-gray-200 rounded-b-lg shadow-xl z-[1000] max-h-60 overflow-y-auto"></div>
                    </div>
                    <p class="text-xs font-medium text-gray-400 mt-1 flex items-center gap-1">
                        <i class="fas fa-phone-alt"></i> ‡ªÄ‡∫ö‡∫µ‡ªÇ‡∫ó: <span id="cust_phone_display" class="text-gray-600 font-bold">-</span>
                    </p>
                    <input type="hidden" id="cust_phone">
                    <input type="hidden" id="cust_id">
                </div>
                <!-- Customer Code -->
                <div class="md:col-span-4 flex flex-col gap-1.5">
                    <label class="block text-sm font-bold text-gray-700">‡∫•‡∫∞‡∫´‡∫±‡∫î‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤ / Code</label>
                    <input type="text" id="cust_code" class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg text-gray-500 font-bold outline-none" readonly placeholder="Auto">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <!-- Car Reg & Province -->
                <div class="lg:col-span-2 grid grid-cols-2 gap-3">
                    <div class="flex flex-col gap-1.5">
                        <label class="block text-sm font-bold text-gray-700">‡∫ó‡∫∞‡∫ö‡∫Ω‡∫ô‡∫•‡∫ª‡∫î / Reg. No</label>
                        <input type="text" id="car_reg" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none transition-all" placeholder="‡∫ó‡∫∞‡∫ö‡∫Ω‡∫ô">
                    </div>
                    <div class="flex flex-col gap-1.5">
                        <label class="block text-sm font-bold text-gray-700">‡ªÅ‡∫Ç‡∫ß‡∫á / Province</label>
                        <input type="text" id="car_prov" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none transition-all" placeholder="‡ªÅ‡∫Ç‡∫ß‡∫á">
                    </div>
                </div>
                <!-- Mileage -->
                <div class="flex flex-col gap-1.5">
                    <label class="block text-sm font-bold text-gray-700">‡ªÄ‡∫•‡∫Å km / Mileage</label>
                    <input type="number" id="car_mileage" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none transition-all" placeholder="0">
                </div>
                <div class="hidden lg:block space-y-1.5"></div> <!-- Spacer -->
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <!-- Brand & Model -->
                <div class="lg:col-span-2 grid grid-cols-2 gap-3">
                    <div class="flex flex-col gap-1.5">
                        <label class="block text-sm font-bold text-gray-700">‡∫ç‡∫µ‡ªà‡∫´‡ªç‡ªâ / Brand</label>
                        <input type="text" id="car_brand" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none transition-all" placeholder="‡∫ç‡∫µ‡ªà‡∫´‡ªç‡ªâ">
                    </div>
                    <div class="flex flex-col gap-1.5">
                        <label class="block text-sm font-bold text-gray-700">‡∫•‡∫∏‡ªâ‡∫ô / Model</label>
                        <input type="text" id="car_model" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none transition-all" placeholder="‡∫•‡∫∏‡ªâ‡∫ô">
                    </div>
                </div>
                <!-- Frame No & Color -->
                <div class="lg:col-span-2 grid grid-cols-3 gap-3">
                    <div class="col-span-2 flex flex-col gap-1.5">
                        <label class="block text-sm font-bold text-gray-700">‡ªÄ‡∫•‡∫Å‡∫ñ‡∫±‡∫á / Frame No</label>
                        <input type="text" id="car_frame" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none transition-all" placeholder="‡ªÄ‡∫•‡∫Å‡∫ñ‡∫±‡∫á">
                    </div>
                    <div class="flex flex-col gap-1.5">
                        <label class="block text-sm font-bold text-gray-700">‡∫™‡∫µ / Color</label>
                        <input type="text" id="car_color" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none transition-all" placeholder="‡∫™‡∫µ">
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Mechanic & Sales Rep -->
                <div class="lg:col-span-2 flex flex-col gap-1.5">
                    <label class="block text-sm font-bold text-gray-700">‡∫ä‡ªà‡∫≤‡∫á‡∫™‡ªâ‡∫≠‡∫° / Mechanic</label>
                    <input type="text" id="mechanic_name" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none transition-all" placeholder="‡∫ä‡∫∑‡ªà‡∫ä‡ªà‡∫≤‡∫á">
                </div>
                <div class="lg:col-span-2 flex flex-col gap-1.5">
                    <label class="block text-sm font-bold text-gray-700">‡∫û‡∫∞‡∫ô‡∫±‡∫Å‡∫á‡∫≤‡∫ô‡∫Ç‡∫≤‡∫ç / Sales Rep.</label>
                    <select id="sale_rep" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none transition-all font-bold text-gray-700 bg-white" onchange="syncReceivedBy()">
                        <option value="{{ request.user.username }}">{{ request.user.username }}</option>
                        {% for rep in sale_reps %}
                        {% if rep != request.user.username %}
                        <option value="{{ rep }}">{{ rep }}</option>
                        {% endif %}
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <!-- Section 3: Items Table -->
        <div class="mb-10">
            <div class="bg-gray-100 px-4 py-2 font-bold text-gray-800 border-l-4 border-red-600 mb-6 flex justify-between items-center">
                <span class="flex items-center gap-2"><i class="fas fa-boxes text-red-600"></i> ‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤ / Items</span>
                <button type="button" class="inline-flex items-center gap-2 px-4 py-1.5 bg-gray-800 text-white text-sm font-bold rounded hover:bg-gray-900 transition-all shadow-sm" onclick="addRow()">
                    <i class="fas fa-plus"></i> ‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô
                </button>
            </div>

            <div class="overflow-x-auto rounded-xl border border-gray-200 shadow-sm mb-6">
                <table class="w-full text-left border-collapse min-w-[1000px]" id="itemsTable">
                    <thead>
                        <tr class="bg-gray-50 border-b border-gray-200 text-xs font-bold text-gray-600 uppercase tracking-wider">
                            <th class="px-4 py-3 text-center w-12">No</th>
                            <th class="px-4 py-3 w-40">Ref. Code</th>
                            <th class="px-4 py-3">‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô / Description</th>
                            <th class="px-4 py-3 w-28 text-center">‡∫à‡∫≥‡∫ô‡∫ß‡∫ô / Qty</th>
                            <th class="px-4 py-3 w-28 text-center">‡ªú‡ªà‡∫ß‡∫ç / Unit</th>
                            <th class="px-4 py-3 w-40 text-right">‡∫•‡∫≤‡∫Ñ‡∫≤ / Price</th>
                            <th class="px-4 py-3 w-40 text-center text-xs">‡∫™‡ªà‡∫ß‡∫ô‡∫´‡∫º‡∫∏‡∫î %</th>
                            <th class="px-4 py-3 w-40 text-right">‡∫à‡∫≥‡∫ô‡∫ß‡∫ô‡ªÄ‡∫á‡∫¥‡∫ô / Amount</th>
                            <th class="px-4 py-3 w-12 text-center"><i class="fas fa-trash"></i></th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100 bg-white">
                        <!-- Dynamic Rows Here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Section 4: Totals & Payment -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
            <div>
                <div class="bg-gray-100 px-4 py-2 font-bold text-gray-800 border-l-4 border-red-600 mb-6 flex items-center gap-2">
                    <i class="fas fa-money-bill-wave text-red-600"></i> ‡∫Å‡∫≤‡∫ô‡∫à‡ªà‡∫≤‡∫ç‡ªÄ‡∫á‡∫¥‡∫ô / Payment
                </div>
                
                <div class="space-y-6">
                    <div class="space-y-1.5">
                        <label class="block text-sm font-bold text-gray-700">‡∫ú‡∫π‡ªâ‡∫Æ‡∫±‡∫ö‡ªÄ‡∫á‡∫¥‡∫ô / Received By</label>
                        <select id="received_by" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none transition-all font-bold text-gray-700 bg-white">
                            <option value="{{ request.user.username }}">{{ request.user.username }}</option>
                            {% for rep in sale_reps %}
                            {% if rep != request.user.username %}
                            <option value="{{ rep }}">{{ rep }}</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                    </div>

                    <div class="grid grid-cols-2 gap-6">
                        <div class="space-y-1.5">
                            <label class="block text-sm font-bold text-gray-700">‡ªÄ‡∫•‡∫Å‡∫ó‡∫µ‡ªÄ‡∫ä‡∫±‡∫Å / Check No.</label>
                            <input type="text" id="check_no" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none transition-all" placeholder="‡ªÄ‡∫•‡∫Å‡∫ó‡∫µ‡ªÄ‡∫ä‡∫±‡∫Å">
                        </div>
                        <div class="space-y-1.5">
                            <label class="block text-sm font-bold text-gray-700">‡∫ß‡∫±‡∫ô‡∫ó‡∫µ‡ªÉ‡∫ô‡ªÄ‡∫ä‡∫±‡∫Å / Date</label>
                            <input type="date" id="check_date" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none transition-all">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-6">
                        <div class="space-y-1.5">
                            <label class="block text-sm font-bold text-gray-700">‡∫ó‡∫∞‡∫ô‡∫≤‡∫Ñ‡∫≤‡∫ô / Bank</label>
                            <select id="bank_name" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none transition-all bg-white">
                                <option value="">-- ‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫ó‡∫∞‡∫ô‡∫≤‡∫Ñ‡∫≤‡∫ô --</option>
                                <option value="‡∫ó‡∫∞‡∫ô‡∫≤‡∫Ñ‡∫≤‡∫ô ‡∫Å‡∫≤‡∫ô‡∫Ñ‡ªâ‡∫≤‡∫ï‡ªà‡∫≤‡∫á‡∫õ‡∫∞‡ªÄ‡∫ó‡∫î‡∫•‡∫≤‡∫ß ‡∫°‡∫∞‡∫´‡∫≤‡∫ä‡∫ª‡∫ô (BCEL)">‡∫ó‡∫∞‡∫ô‡∫≤‡∫Ñ‡∫≤‡∫ô ‡∫Å‡∫≤‡∫ô‡∫Ñ‡ªâ‡∫≤‡∫ï‡ªà‡∫≤‡∫á‡∫õ‡∫∞‡ªÄ‡∫ó‡∫î‡∫•‡∫≤‡∫ß ‡∫°‡∫∞‡∫´‡∫≤‡∫ä‡∫ª‡∫ô (BCEL)</option>
                                <option value="‡∫ó‡∫∞‡∫ô‡∫≤‡∫Ñ‡∫≤‡∫ô ‡∫™‡∫ª‡ªà‡∫á‡ªÄ‡∫™‡∫µ‡∫°‡∫Å‡∫∞‡∫™‡∫¥‡∫Å‡∫≥ (APB)">‡∫ó‡∫∞‡∫ô‡∫≤‡∫Ñ‡∫≤‡∫ô ‡∫™‡∫ª‡ªà‡∫á‡ªÄ‡∫™‡∫µ‡∫°‡∫Å‡∫∞‡∫™‡∫¥‡∫Å‡∫≥ (APB)</option>
                                <option value="‡∫ó‡∫∞‡∫ô‡∫≤‡∫Ñ‡∫≤‡∫ô ‡∫û‡∫±‡∫î‡∫ó‡∫∞‡∫ô‡∫≤‡∫•‡∫≤‡∫ß (LDB)">‡∫ó‡∫∞‡∫ô‡∫≤‡∫Ñ‡∫≤‡∫ô ‡∫û‡∫±‡∫î‡∫ó‡∫∞‡∫ô‡∫≤‡∫•‡∫≤‡∫ß (LDB)</option>
                                <option value="‡∫ó‡∫∞‡∫ô‡∫≤‡∫Ñ‡∫≤‡∫ô ‡∫Æ‡ªà‡∫ß‡∫°‡∫û‡∫±‡∫î‡∫ó‡∫∞‡∫ô‡∫≤ (JDB)">‡∫ó‡∫∞‡∫ô‡∫≤‡∫Ñ‡∫≤‡∫ô ‡∫Æ‡ªà‡∫ß‡∫°‡∫û‡∫±‡∫î‡∫ó‡∫∞‡∫ô‡∫≤ (JDB)</option>
                                <option value="‡∫ó‡∫∞‡∫ô‡∫≤‡∫Ñ‡∫≤‡∫ô ‡∫û‡∫ª‡∫á‡∫™‡∫∞‡∫´‡∫ß‡∫±‡∫ô (Phongsavanh Bank)">‡∫ó‡∫∞‡∫ô‡∫≤‡∫Ñ‡∫≤‡∫ô ‡∫û‡∫ª‡∫á‡∫™‡∫∞‡∫´‡∫ß‡∫±‡∫ô (Phongsavanh Bank)</option>
                                <option value="‡∫ó‡∫∞‡∫ô‡∫≤‡∫Ñ‡∫≤‡∫ô ‡∫≠‡∫¥‡∫ô‡ªÇ‡∫î‡∫à‡∫µ‡∫ô (Indochina Bank)">‡∫ó‡∫∞‡∫ô‡∫≤‡∫Ñ‡∫≤‡∫ô ‡∫≠‡∫¥‡∫ô‡ªÇ‡∫î‡∫à‡∫µ‡∫ô (Indochina Bank)</option>
                            </select>
                        </div>
                        <div class="space-y-1.5">
                            <label class="block text-sm font-bold text-gray-700">‡∫™‡∫≤‡∫Ç‡∫≤ / Branch</label>
                            <input type="text" id="bank_branch" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none transition-all" placeholder="‡∫™‡∫≤‡∫Ç‡∫≤">
                        </div>
                    </div>

                    <div class="overflow-hidden rounded-xl border border-yellow-200 shadow-sm">
                        <table class="w-full text-sm">
                            <thead class="bg-yellow-100/50 border-b border-yellow-200">
                                <tr class="text-left font-bold text-yellow-800">
                                    <th class="px-4 py-3">‡∫ß‡∫¥‡∫ó‡∫µ‡∫à‡ªà‡∫≤‡∫ç / Method</th>
                                    <th class="px-4 py-3 text-right">‡∫à‡∫≥‡∫ô‡∫ß‡∫ô / Amount (‡∏ø)</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-yellow-100 bg-yellow-50/30">
                                <tr class="hover:bg-yellow-50 transition-colors">
                                    <td class="px-4 py-3">
                                        <label class="inline-flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" id="cash_check" class="rounded text-yellow-600 focus:ring-yellow-500">
                                            <span class="font-medium text-gray-700 underline decoration-yellow-300">‡ªÄ‡∫á‡∫¥‡∫ô‡∫™‡∫ª‡∫î / Cash</span>
                                        </label>
                                    </td>
                                    <td class="px-4 py-3">
                                        <input type="number" id="payment_cash" class="w-full px-3 py-1.5 border border-yellow-200 rounded-lg text-right focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 outline-none transition-all font-bold text-yellow-900" value="0" step="0.01" oninput="calcPaymentTotal()">
                                    </td>
                                </tr>
                                <tr class="hover:bg-yellow-50 transition-colors">
                                    <td class="px-4 py-3">
                                        <label class="inline-flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" id="check_check" class="rounded text-yellow-600 focus:ring-yellow-500">
                                            <span class="font-medium text-gray-700 underline decoration-yellow-300">‡ªÄ‡∫ä‡∫±‡∫Å‡∫ó‡∫∞‡∫ô‡∫≤‡∫Ñ‡∫≤‡∫ô / Check</span>
                                        </label>
                                    </td>
                                    <td class="px-4 py-3">
                                        <input type="number" id="payment_check" class="w-full px-3 py-1.5 border border-yellow-200 rounded-lg text-right focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 outline-none transition-all font-bold text-yellow-900" value="0" step="0.01" oninput="calcPaymentTotal()">
                                    </td>
                                </tr>
                                <tr class="hover:bg-yellow-50 transition-colors">
                                    <td class="px-4 py-3">
                                        <label class="inline-flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" id="credit_check" class="rounded text-yellow-600 focus:ring-yellow-500">
                                            <span class="font-medium text-gray-700 underline decoration-yellow-300">‡∫ï‡∫¥‡∫î‡ªú‡∫µ‡ªâ / Credit</span>
                                        </label>
                                    </td>
                                    <td class="px-4 py-3">
                                        <input type="number" id="payment_credit" class="w-full px-3 py-1.5 border border-yellow-200 rounded-lg text-right focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 outline-none transition-all font-bold text-yellow-900" value="0" step="0.01" oninput="calcPaymentTotal()">
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="flex flex-col justify-between">
                <div class="bg-gray-50 p-8 rounded-2xl border border-gray-100 shadow-sm space-y-4">
                    <h5 class="font-bold text-gray-800 flex items-center gap-2 mb-2">
                        <i class="fas fa-calculator text-red-600"></i> ‡∫ç‡∫≠‡∫î‡∫•‡∫ß‡∫° / Summary
                    </h5>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-500 font-medium whitespace-nowrap">‡∫•‡∫ß‡∫°‡∫ç‡∫≠‡∫î‡∫™‡ªà‡∫ß‡∫ô‡∫´‡∫º‡∫∏‡∫î / Total Discount</span>
                            <span class="font-bold text-red-600" id="total_discount_display">0.00 ‡∏ø</span>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-500 font-medium whitespace-nowrap">‡∫•‡∫ß‡∫°‡∫ç‡∫≠‡∫î‡∫•‡∫ß‡∫° / Subtotal</span>
                            <span class="font-bold text-gray-900" id="subtotal_display">0.00 ‡∏ø</span>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <div class="flex items-center gap-2">
                                <span class="text-gray-500 font-medium whitespace-nowrap">‡∫≠‡∫≤‡∫Å‡∫≠‡∫ô / Tax</span>
                                <input type="number" id="tax_percent" value="0" step="0.01" class="w-16 px-2 py-0.5 border border-gray-200 rounded text-center text-xs outline-none focus:ring-1 focus:ring-red-500" oninput="calcGrandTotal()">
                                <span class="text-xs font-bold text-gray-400">%</span>
                            </div>
                            <span class="font-bold text-gray-900" id="tax_amount_display">0.00 ‡∏ø</span>
                        </div>
                        <div class="pt-4 border-t border-gray-200">
                            <div class="flex justify-between items-end mb-4">
                                <span class="text-lg font-bold text-gray-900">‡∫•‡∫ß‡∫°‡∫™‡∫∏‡∫î‡∫ó‡∫¥ / Net Total (THB)</span>
                                <span class="text-4xl font-black text-blue-600" id="grand_total_thb_display">0.00 ‡∏ø</span>
                            </div>
                            <div class="space-y-1 pl-1 border-l-2 border-gray-200">
                                <div class="flex justify-between items-center text-xs text-gray-400 italic">
                                    <span>Estimated LAK (‚Ç≠)</span>
                                    <span id="grand_total_lak_display">0.00 ‚Ç≠</span>
                                </div>
                                <div class="flex justify-between items-center text-xs text-gray-400 italic">
                                    <span>Estimated USD ($)</span>
                                    <span id="grand_total_usd_display">0.00 $</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="mt-8">
                    <button type="button" class="w-full py-4 bg-gray-900 text-white rounded-xl font-black text-xl shadow-xl hover:bg-black transition-all active:scale-[0.98] border-b-4 border-gray-700 flex items-center justify-center gap-3 uppercase tracking-wider" onclick="submitBill()">
                        <i class="fas fa-save shadow-sm"></i>
                        <span>‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å ‡ªÅ‡∫•‡∫∞ ‡∫≠‡∫≠‡∫Å‡∫ö‡∫¥‡∫ô / Save & Print Bill</span>
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>


<script>
    // Exchange Rates (Passed from View preferably, or hardcoded for now then updated via API)
    // For manual entry, we'll let the backend handle the final conversion, but we can show estimates.
    const rateLak = parseFloat("{{ rate_lak|default:0 }}");
    const rateUsd = parseFloat("{{ rate_usd|default:0 }}");

    // --- Customer Search Logic ---
    const custInput = document.getElementById('cust_name');
    const custResult = document.getElementById('cust_autocomplete');
    let searchTimeout;

    custInput.addEventListener('input', function(e) {
        const query = e.target.value.trim();
        if (query.length < 2) {
            custResult.style.display = 'none';
            return;
        }

        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            fetch(`/api/search-customer/?q=${encodeURIComponent(query)}`)
                .then(res => res.json())
                .then(data => {
                    custResult.innerHTML = '';
                    if (data.results.length > 0) {
                        data.results.forEach(c => {
                            const item = document.createElement('div');
                            item.className = 'px-4 py-3 hover:bg-red-50 cursor-pointer border-b border-gray-50 last:border-0 transition-colors';
                            item.innerHTML = `
                                <div class="flex justify-between items-start">
                                    <div>
                                        <div class="font-bold text-gray-800">${c.name}</div>
                                        <div class="text-xs text-gray-400 italic">${c.car_brand || '-'} ${c.car_model || '-'} | ${c.car_register_no || '-'}</div>
                                    </div>
                                    <div class="text-xs font-black text-red-600 bg-red-50 px-2 py-1 rounded-md border border-red-100">${c.code}</div>
                                </div>
                                <div class="mt-1 text-xs text-gray-500 font-medium whitespace-nowrap overflow-hidden text-ellipsis">
                                    <i class="fas fa-phone-alt mr-1"></i> ${c.phone}
                                </div>
                            `;
                            item.onclick = () => selectCustomer(c);
                            custResult.appendChild(item);
                        });
                        custResult.style.display = 'block';
                        custResult.classList.remove('hidden');
                    } else {
                        custResult.style.display = 'none';
                        custResult.classList.add('hidden');
                    }
                });
        }, 300);
    });

    function selectCustomer(c) {
        document.getElementById('cust_id').value = c.id;
        document.getElementById('cust_code').value = c.code;
        document.getElementById('cust_name').value = c.name;
        document.getElementById('cust_phone').value = c.phone;
        document.getElementById('cust_phone_display').innerText = c.phone;

        document.getElementById('car_reg').value = c.car_register_no || '';
        document.getElementById('car_prov').value = c.car_province || '';
        document.getElementById('car_brand').value = c.car_brand || '';
        document.getElementById('car_model').value = c.car_model || '';
        document.getElementById('car_frame').value = c.car_frame_no || '';
        document.getElementById('car_color').value = c.car_color || '';

        document.getElementById('mechanic_name').value = c.mechanic_name || '';

        // Set sale_rep if customer has a saved value
        if (c.sale_representative) {
            document.getElementById('sale_rep').value = c.sale_representative;
        }

        // Sync received_by with sale_rep
        syncReceivedBy();

        custResult.style.display = 'none';
    }

    // --- Table Logic ---
    let rowCount = 0;

    function addRow() {
        rowCount++;
        const tbody = document.querySelector('#itemsTable tbody');
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50/50 transition-colors group';
        tr.innerHTML = `
            <td class="px-4 py-3 text-center text-sm font-medium text-gray-500">${rowCount}</td>
            <td class="px-4 py-3">
                <input type="text" class="w-full px-3 py-1.5 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none transition-all text-sm item-refcode" placeholder="Ref.">
            </td>
            <td class="px-4 py-3 relative">
                <input type="text" class="w-full px-3 py-1.5 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none transition-all text-sm font-bold text-gray-700 item-desc" placeholder="‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤" autocomplete="off">
                <div class="hidden absolute top-full left-4 right-4 bg-white border border-gray-200 rounded-b-lg shadow-xl z-[1000] max-h-60 overflow-y-auto prod-autocomplete"></div>
            </td>
            <td class="px-4 py-3">
                <input type="number" class="w-full px-3 py-1.5 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none transition-all text-sm text-center font-bold item-qty" value="1" oninput="calcTotal(this)">
            </td>
            <td class="px-4 py-3">
                <input type="text" class="w-full px-3 py-1.5 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none transition-all text-sm text-center item-unit" value="‡∫≠‡∫±‡∫ô">
            </td>
            <td class="px-4 py-3">
                <input type="number" class="w-full px-3 py-1.5 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none transition-all text-sm text-right font-bold item-price" value="0" step="0.01" oninput="calcTotal(this)">
            </td>
            <td class="px-4 py-3">
                <input type="number" class="w-full px-3 py-1.5 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none transition-all text-sm text-center font-bold text-red-600 item-disc-amount" placeholder="0%" value="0" step="0.1" oninput="calcTotal(this)">
            </td>
            <td class="px-4 py-3">
                <input type="text" class="w-full px-3 py-1.5 bg-gray-50 border border-gray-200 rounded-lg text-right text-sm font-black text-blue-600 item-total" readonly value="0.00">
            </td>
            <td class="px-4 py-3 text-center">
                <button type="button" class="w-8 h-8 flex items-center justify-center rounded-full text-gray-300 hover:text-red-600 hover:bg-red-50 transition-all opacity-0 group-hover:opacity-100" onclick="removeRow(this)">
                    <i class="fas fa-times"></i>
                </button>
            </td>
        `;
        tbody.appendChild(tr);

        // Add Product Autocomplete Event
        const descInput = tr.querySelector('.item-desc');
        const prodResult = tr.querySelector('.prod-autocomplete');
        let prodTimeout;

        descInput.addEventListener('input', function(e) {
            const query = e.target.value.trim();
            if (query.length < 2) {
                prodResult.style.display = 'none';
                return;
            }

            clearTimeout(prodTimeout);
            prodTimeout = setTimeout(() => {
                fetch(`/api/search-product/?q=${encodeURIComponent(query)}`)
                    .then(res => res.json())
                    .then(data => {
                        prodResult.innerHTML = '';
                        if (data.results.length > 0) {
                            data.results.forEach(p => {
                                const item = document.createElement('div');
                                item.className = 'px-4 py-2 hover:bg-red-50 cursor-pointer border-b border-gray-50 last:border-0 transition-colors';
                                item.innerHTML = `
                                    <div class="font-bold text-gray-800 text-sm">${p.name}</div>
                                    <div class="text-xs text-gray-400 flex justify-between">
                                        <span>Barcode: ${p.barcode}</span>
                                        <span class="text-red-600 font-bold">‡∏ø${parseFloat(p.price).toLocaleString()}</span>
                                    </div>
                                `;
                                item.onclick = () => selectProduct(tr, p);
                                prodResult.appendChild(item);
                            });
                            prodResult.style.display = 'block';
                            prodResult.classList.remove('hidden');
                        } else {
                            prodResult.style.display = 'none';
                            prodResult.classList.add('hidden');
                        }
                    });
            }, 300);
        });

        // Close dropdown if clicked outside
        document.addEventListener('click', function(e) {
            if (!descInput.contains(e.target) && !prodResult.contains(e.target)) {
                prodResult.style.display = 'none';
            }
        });

        // Handle Enter key on Description
        descInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                // If there's exactly one result, select it
                const firstItem = prodResult.querySelector('a');
                if (firstItem && prodResult.style.display !== 'none') {
                    firstItem.click();
                } else {
                    // Just move to Qty
                    tr.querySelector('.item-qty').focus();
                }
            }
        });
    }

    function selectProduct(tr, p) {
        tr.querySelector('.item-refcode').value = p.barcode;
        tr.querySelector('.item-desc').value = p.name;
        tr.querySelector('.item-price').value = p.price;
        tr.querySelector('.item-unit').value = p.unit || '‡∫≠‡∫±‡∫ô';
        tr.querySelector('.prod-autocomplete').style.display = 'none';
        
        calcTotal(tr.querySelector('.item-price'));
        tr.querySelector('.item-qty').focus();
    }

    function removeRow(btn) {
        btn.closest('tr').remove();
        calcGrandTotal();
    }

    function calcTotal(input) {
        const tr = input.closest('tr');
        const qty = parseFloat(tr.querySelector('.item-qty').value) || 0;
        const price = parseFloat(tr.querySelector('.item-price').value) || 0;
        let discPercent = parseFloat(tr.querySelector('.item-disc-amount').value) || 0;

        const discountAmount = (price * qty * discPercent) / 100;
        const subtotal = (price * qty) - discountAmount;
        tr.querySelector('.item-total').value = subtotal.toFixed(2);

        calcGrandTotal();
    }

    function calcGrandTotal() {
        let subtotal = 0;
        let totalDisc = 0;

        document.querySelectorAll('#itemsTable tbody tr').forEach(tr => {
            const price = parseFloat(tr.querySelector('.item-price').value) || 0;
            const qty = parseFloat(tr.querySelector('.item-qty').value) || 0;
            const discPercent = parseFloat(tr.querySelector('.item-disc-amount').value) || 0;
            
            const lineTotal = price * qty;
            const discAmount = (lineTotal * discPercent) / 100;
            const itemTotal = lineTotal - discAmount;
            
            subtotal += itemTotal;
            totalDisc += discAmount;
        });

        // Calculate tax
        const taxPercent = parseFloat(document.getElementById('tax_percent').value) || 0;
        const taxAmount = (subtotal * taxPercent) / 100;
        const grandTotal = subtotal + taxAmount;

        // Update displays
        document.getElementById('total_discount_display').innerText = totalDisc.toFixed(2) + ' ‡∏ø';
        document.getElementById('subtotal_display').innerText = subtotal.toFixed(2) + ' ‡∏ø';
        document.getElementById('tax_amount_display').innerText = taxAmount.toFixed(2) + ' ‡∏ø';
        document.getElementById('grand_total_thb_display').innerText = grandTotal.toFixed(2) + ' ‡∏ø';

        // Estimates for other currencies (Using multiplication based on user rate config)
        const lak = rateLak > 0 ? (grandTotal * rateLak) : 0;
        const usd = rateUsd > 0 ? (grandTotal * rateUsd) : 0;

        document.getElementById('grand_total_lak_display').innerText = lak.toLocaleString(undefined, {maximumFractionDigits: 0}) + ' ‚Ç≠';
        document.getElementById('grand_total_usd_display').innerText = usd.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' $';
    }

    function calcPaymentTotal() {
        // Auto-check boxes if amount > 0
        const cash = parseFloat(document.getElementById('payment_cash').value) || 0;
        const check = parseFloat(document.getElementById('payment_check').value) || 0;
        const credit = parseFloat(document.getElementById('payment_credit').value) || 0;

        document.getElementById('cash_check').checked = cash > 0;
        document.getElementById('check_check').checked = check > 0;
        document.getElementById('credit_check').checked = credit > 0;
    }

    // Sync Received By with Sales Rep
    function syncReceivedBy() {
        const saleRepValue = document.getElementById('sale_rep').value;
        document.getElementById('received_by').value = saleRepValue;
    }

    // Initialize one row
    addRow();

    // --- Submit Logic ---
    function submitBill() {
        const items = [];
        document.querySelectorAll('#itemsTable tbody tr').forEach(tr => {
            items.push({
                ref_code: tr.querySelector('.item-refcode').value,
                desc: tr.querySelector('.item-desc').value,
                qty: tr.querySelector('.item-qty').value,
                unit: tr.querySelector('.item-unit').value,
                price: tr.querySelector('.item-price').value,
                discount: tr.querySelector('.item-disc-amount').value
            });
        });

        const taxPercent = parseFloat(document.getElementById('tax_percent').value) || 0;

        const data = {
            customer: {
                name: document.getElementById('cust_name').value,
                phone: document.getElementById('cust_phone').value || document.getElementById('cust_phone_display').innerText,
                code: document.getElementById('cust_code').value
            },
            car: {
                register_no: document.getElementById('car_reg').value,
                province: document.getElementById('car_prov').value,
                brand: document.getElementById('car_brand').value,
                model: document.getElementById('car_model').value,
                frame: document.getElementById('car_frame').value,
                color: document.getElementById('car_color').value,
                mileage: document.getElementById('car_mileage').value
            },
            mechanic: {
                name: document.getElementById('mechanic_name').value,
                rep: document.getElementById('sale_rep').value
            },
            payment: {
                received_by: document.getElementById('received_by').value,
                check_no: document.getElementById('check_no').value,
                check_date: document.getElementById('check_date').value,
                bank_name: document.getElementById('bank_name').value,
                bank_branch: document.getElementById('bank_branch').value,
                amount_cash: parseFloat(document.getElementById('payment_cash').value) || 0,
                amount_check: parseFloat(document.getElementById('payment_check').value) || 0,
                amount_credit: parseFloat(document.getElementById('payment_credit').value) || 0
            },
            tax_percent: taxPercent,
            items: items
        };

        // Reuse api_checkout or create new endpoint? 
        // api_checkout expects "items" with ID (for products). Here we have manual items.
        // We need a NEW endpoint for Manual Bill because api_checkout is tied to Stock/Product IDs.
        // Manual bill might use free-text items.
        
        fetch('/api/manual-checkout/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
            body: JSON.stringify(data)
        })
        .then(res => res.json())
        .then(res => {
            if(res.success) {
                window.location.href = `/orders/${res.invoice_no}/`;
            } else {
                alert('Error: ' + res.error);
            }
        });
    }
</script>
{% endblock %}
