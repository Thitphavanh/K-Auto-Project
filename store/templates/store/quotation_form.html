{% extends 'base.html' %}
{% load static humanize %}

{% block title %}{% if is_update %}‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç‡ªÉ‡∫ö‡∫™‡∫∞‡ªÄ‡ªú‡∫µ‡∫•‡∫≤‡∫Ñ‡∫≤{% else %}‡∫™‡ªâ‡∫≤‡∫á‡ªÉ‡∫ö‡∫™‡∫∞‡ªÄ‡ªú‡∫µ‡∫•‡∫≤‡∫Ñ‡∫≤{% endif %} - K-Auto{% endblock %}

{% block content %}
<div class="min-h-screen">
    <div class="container mx-auto px-4 max-w-8xl">
        <form method="POST">
            {% csrf_token %}
            
            <!-- Header -->
            <div class="flex flex-col md:flex-row justify-between items-center mb-8 border-b border-gray-200 dark:border-gray-700 pb-4">
                <div class="flex items-center gap-4">
                    <a href="{% url 'quotation_list' %}" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors">
                        <i class="fas fa-arrow-left text-xl"></i>
                    </a>
                    <div>
                        <h1 class="text-2xl font-bold">
                            {% if is_update %}
                                üìù ‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç‡ªÉ‡∫ö‡∫™‡∫∞‡ªÄ‡ªú‡∫µ‡∫•‡∫≤‡∫Ñ‡∫≤ {{ quotation.quotation_no }}
                            {% else %}
                                üìÑ ‡∫™‡ªâ‡∫≤‡∫á‡ªÉ‡∫ö‡∫™‡∫∞‡ªÄ‡ªú‡∫µ‡∫•‡∫≤‡∫Ñ‡∫≤‡ªÉ‡ªù‡ªà (New Quotation)
                            {% endif %}
                        </h1>
                        <p class="text-sm text-gray-500">‡ªÉ‡∫™‡ªà‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤ ‡ªÅ‡∫•‡∫∞ ‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡∫õ‡∫∞‡ªÄ‡∫°‡∫µ‡∫ô‡∫•‡∫≤‡∫Ñ‡∫≤</p>
                    </div>
                </div>
                <div class="flex gap-3 mt-4 md:mt-0">
                    <button type="submit" class="inline-flex items-center px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl shadow-md transition-all">
                        <i class="fas fa-save mr-2"></i> ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Customer Info -->
                <div class="rounded-2xl shadow-sm p-6 border border-gray-100 dark:border-gray-700">
                    <h3 class="text-lg font-bold mb-4 border-l-4 border-blue-500 pl-3">
                        ‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤ (Customer)
                    </h3>
                    <div class="space-y-4">
                         <div>
                            <label class="block text-sm font-medium mb-1">‡∫ä‡∫∑‡ªà‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤ *</label>
                            <input type="text" name="customer_name" class="w-full rounded-lg border-gray-300 dark:border-gray-600 focus:ring-blue-500 focus:border-blue-500" value="{{ quotation.customer_name|default:'' }}" required placeholder="‡∫ä‡∫∑‡ªà‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤...">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">‡ªÄ‡∫ö‡∫µ‡ªÇ‡∫ó</label>
                            <input type="text" name="customer_phone" class="w-full rounded-lg border-gray-300 dark:border-gray-600 focus:ring-blue-500 focus:border-blue-500" value="{{ quotation.customer_phone|default:'' }}" placeholder="‡ªÄ‡∫ö‡∫µ‡ªÇ‡∫ó‡∫ï‡∫¥‡∫î‡∫ï‡ªç‡ªà...">
                        </div>
                    </div>
                </div>

                <!-- Car Info -->
                <div class="rounded-2xl shadow-sm p-6 border border-gray-100 dark:border-gray-700">
                    <h3 class="text-lg font-bold mb-4 border-l-4 border-purple-500 pl-3">
                        ‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫•‡∫ª‡∫î (Vehicle)
                    </h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">‡∫ó‡∫∞‡∫ö‡∫Ω‡∫ô‡∫•‡∫ª‡∫î</label>
                            <input type="text" name="car_register_no" class="w-full rounded-lg border-gray-300 dark:border-gray-600" value="{{ quotation.car_register_no|default:'' }}" placeholder="‡∫ó‡∫∞‡∫ö‡∫Ω‡∫ô‡∫•‡∫ª‡∫î...">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">‡∫ç‡∫µ‡ªà‡∫´‡ªç‡ªâ</label>
                            <input type="text" name="car_brand" class="w-full rounded-lg border-gray-300 dark:border-gray-600" value="{{ quotation.car_brand|default:'' }}" placeholder="‡∫ç‡∫µ‡ªà‡∫´‡ªç‡ªâ...">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">‡∫•‡∫∏‡ªâ‡∫ô (Model)</label>
                            <input type="text" name="car_model" class="w-full rounded-lg border-gray-300 dark:border-gray-600" value="{{ quotation.car_model|default:'' }}" placeholder="‡∫•‡∫∏‡ªâ‡∫ô (Model)...">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">‡ªÄ‡∫•‡∫Å‡∫Å‡∫¥‡ªÇ‡∫• (Km)</label>
                            <input type="text" name="car_mileage" class="w-full rounded-lg border-gray-300 dark:border-gray-600" value="{{ quotation.car_mileage|default:'' }}" placeholder="‡ªÄ‡∫•‡∫Å‡∫Å‡∫¥‡ªÇ‡∫• (Km)...">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Items -->
            <div class="rounded-2xl shadow-sm p-6 border border-gray-100 dark:border-gray-700 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold border-l-4 border-green-500 pl-3">
                        ‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤/‡∫ö‡ªç‡∫•‡∫¥‡∫Å‡∫≤‡∫ô
                    </h3>
                    <button type="button" id="addRow" class="px-3 py-1.5 bg-green-100 text-green-700 hover:bg-green-200 rounded-lg text-sm font-medium transition-colors">
                        <i class="fas fa-plus mr-1"></i> ‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡ªÅ‡∫ñ‡∫ß
                    </button>
                    <input type="hidden" name="item_count" id="itemCount" value="{{ items|length|default:1 }}">
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse" id="itemsTable">
                        <thead>
                            <tr class="bg-gray-50 text-xs uppercase border-b border-gray-200 dark:border-gray-600">
                                <th class="p-3 w-12 text-center">#</th>
                                <th class="p-3">‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô (Description)</th>
                                <th class="p-3 w-24 text-center">‡∫à‡∫≥‡∫ô‡∫ß‡∫ô</th>
                                <th class="p-3 w-32 text-center">‡∫•‡∫≤‡∫Ñ‡∫≤/‡ªú‡ªà‡∫ß‡∫ç</th>
                                <th class="p-3 w-32 text-right">‡∫•‡∫ß‡∫°</th>
                                <th class="p-3 w-12"></th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
                            <!-- Template Row (Hidden/JS use) -->
                            {% if items %}
                                {% for item in items %}
                                <tr>
                                    <td class="p-3 text-center text-gray-500">{{ forloop.counter }}</td>
                                    <td class="p-3">
                                        <input type="text" name="item_description[]" value="{{ item.description }}" class="w-full rounded border-gray-200 dark:border-gray-600 p-1.5 focus:ring-1 focus:ring-blue-500" required>
                                        <input type="hidden" name="item_product_id[]" value="{{ item.product.id|default:'' }}">
                                    </td>
                                    <td class="p-3">
                                        <input type="number" step="any" name="item_quantity[]" value="{{ item.quantity|floatformat:0 }}" class="qty-input w-full text-center rounded border-gray-200 dark:border-gray-600 p-1.5" min="1">
                                    </td>
                                    <td class="p-3">
                                        <input type="number" step="any" name="item_unit_price[]" value="{{ item.unit_price|floatformat:0 }}" class="price-input w-full text-right rounded border-gray-200 dark:border-gray-600 p-1.5">
                                    </td>
                                    <td class="p-3 text-right font-medium text-gray-900 row-total">
                                        {{ item.amount|floatformat:0 }}
                                    </td>
                                    <td class="p-3 text-center">
                                        <button type="button" class="remove-row text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td class="p-3 text-center text-gray-500">1</td>
                                    <td class="p-3">
                                        <input type="text" name="item_description[]" class="w-full rounded border-gray-200 dark:border-gray-600 p-1.5 focus:ring-1 focus:ring-blue-500" required placeholder="‡∫ä‡∫∑‡ªà‡∫≠‡∫≤‡ªÑ‡∫´‡∫º‡ªà ‡∫´‡∫º‡∫∑ ‡∫Ñ‡ªà‡∫≤‡ªÅ‡∫Æ‡∫á‡∫á‡∫≤‡∫ô...">
                                        <input type="hidden" name="item_product_id[]" value="">
                                    </td>
                                    <td class="p-3">
                                        <input type="number" step="any" name="item_quantity[]" value="1" class="qty-input w-full text-center rounded border-gray-200 dark:border-gray-600 p-1.5" min="1">
                                    </td>
                                    <td class="p-3">
                                        <input type="number" step="any" name="item_unit_price[]" value="0" class="price-input w-full text-right rounded border-gray-200 dark:border-gray-600 p-1.5">
                                    </td>
                                    <td class="p-3 text-right font-medium text-gray-900 row-total">0</td>
                                    <td class="p-3 text-center">
                                        <button type="button" class="remove-row text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                        <tfoot>
                            <tr class="bg-gray-50 dark:bg-gray-800 font-bold">
                                <td colspan="4" class="p-4 text-right text-gray-600 dark:text-gray-300">‡∫ç‡∫≠‡∫î‡∫•‡∫ß‡∫° (Total):</td>
                                <td class="p-4 text-right text-xl text-blue-600" id="grandTotal">0 ‚Ç≠</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tableBody = document.querySelector('#itemsTable tbody');
    const addRowBtn = document.getElementById('addRow');
    const grandTotalEl = document.getElementById('grandTotal');
    
    // --- Autocomplete Logic for Customer ---
    const customerInput = document.getElementsByName('customer_name')[0];
    const customerIdInput = document.createElement('input');
    customerIdInput.type = 'hidden';
    customerIdInput.name = 'customer';
    customerInput.parentNode.appendChild(customerIdInput);
    
    // Create Customer Results Dropdown
    const customerResultsList = document.createElement('ul');
    customerResultsList.className = 'absolute z-50 w-full bg-white border border-gray-200 rounded-lg shadow-lg mt-1 hidden max-h-60 overflow-y-auto';
    customerInput.parentNode.style.position = 'relative';
    customerInput.parentNode.appendChild(customerResultsList);
    
    let customerDebounceTimer;
    
    customerInput.addEventListener('input', function() {
        clearTimeout(customerDebounceTimer);
        const query = this.value.trim();
        
        if (query.length < 2) {
            customerResultsList.classList.add('hidden');
            return;
        }
        
        customerDebounceTimer = setTimeout(() => {
            fetch(`/api/search-customer/?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    customerResultsList.innerHTML = '';
                    if (data.results && data.results.length > 0) {
                        data.results.forEach(customer => {
                            const li = document.createElement('li');
                            li.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm border-b border-gray-100 last:border-0';
                            li.textContent = `${customer.name} (${customer.phone || '-'})`;
                            
                            li.addEventListener('click', () => {
                                // Populate Fields
                                customerInput.value = customer.name;
                                customerIdInput.value = customer.id;
                                
                                document.getElementsByName('customer_phone')[0].value = customer.phone || '';
                                document.getElementsByName('car_register_no')[0].value = customer.car_register_no || '';
                                document.getElementsByName('car_brand')[0].value = customer.car_brand || '';
                                document.getElementsByName('car_model')[0].value = customer.car_model || '';
                                document.getElementsByName('car_mileage')[0].value = customer.car_mileage || '';
                                
                                customerResultsList.classList.add('hidden');
                            });
                            
                            customerResultsList.appendChild(li);
                        });
                        customerResultsList.classList.remove('hidden');
                    } else {
                        customerResultsList.classList.add('hidden');
                    }
                })
                .catch(err => console.error('Error fetching customers:', err));
        }, 300);
    });
    
    // Hide customer dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!customerInput.contains(e.target) && !customerResultsList.contains(e.target)) {
            customerResultsList.classList.add('hidden');
        }
    });

    // --- Helper Functions ---
    function formatNumber(num) {
        return num.toLocaleString('en-US');
    }

    function calculateRow(row) {
        const qty = parseFloat(row.querySelector('.qty-input').value) || 0;
        const price = parseFloat(row.querySelector('.price-input').value) || 0;
        const total = qty * price;
        row.querySelector('.row-total').textContent = formatNumber(total);
        return total;
    }

    function calculateGrandTotal() {
        let total = 0;
        document.querySelectorAll('#itemsTable tbody tr').forEach(row => {
            total += calculateRow(row);
        });
        grandTotalEl.textContent = formatNumber(total) + ' ‚Ç≠';
    }

    // --- Product Autocomplete Logic ---
    function attachProductAutocomplete(row) {
        const descInput = row.querySelector('input[name="item_description[]"]');
        const productIdInput = row.querySelector('input[name="item_product_id[]"]');
        const qtyInput = row.querySelector('.qty-input');
        const priceInput = row.querySelector('.price-input');
        
        // Ensure parent positioning
        descInput.parentNode.style.position = 'relative';

        // Check if dropdown already exists to avoid duplicates
        if (descInput.parentNode.querySelector('.product-results')) {
            return; 
        }

        // Create product results dropdown
        const resultsDiv = document.createElement('div');
        resultsDiv.className = 'product-results absolute z-50 w-full bg-white border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg mt-1 hidden max-h-60 overflow-y-auto';
        descInput.parentNode.appendChild(resultsDiv);

        let debounceTimer;

        descInput.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            const query = this.value.trim();

            if (query.length < 2) {
                resultsDiv.classList.add('hidden');
                return;
            }

            debounceTimer = setTimeout(() => {
                // Call search_products API (using 'term' as per Select2 convention/API view)
                fetch(`/api/search-products/?term=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        resultsDiv.innerHTML = '';
                        if (data && data.length > 0) {
                            data.forEach(product => {
                                const div = document.createElement('div');
                                div.className = 'px-4 py-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-0';
                                div.innerHTML = `
                                    <div class="font-medium text-gray-900">${product.value}</div>
                                    <div class="text-xs text-gray-500">
                                        ‡∫•‡∫∞‡∫´‡∫±‡∫î: ${product.barcode} | ‡∫•‡∫≤‡∫Ñ‡∫≤: ${formatNumber(product.price)} ‚Ç≠
                                    </div>
                                `;

                                div.addEventListener('click', () => {
                                    descInput.value = product.value;
                                    productIdInput.value = product.id;
                                    priceInput.value = product.price;

                                    resultsDiv.classList.add('hidden');
                                    calculateRow(row); // Update row total immediately
                                    calculateGrandTotal();

                                    // Focus on quantity for seamless workflow
                                    qtyInput.focus();
                                    qtyInput.select();
                                });

                                resultsDiv.appendChild(div);
                            });
                            resultsDiv.classList.remove('hidden');
                        } else {
                            resultsDiv.classList.add('hidden');
                        }
                    })
                    .catch(err => console.error('Error fetching products:', err));
            }, 300);
        });

        // Hide dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!descInput.contains(e.target) && !resultsDiv.contains(e.target)) {
                resultsDiv.classList.add('hidden');
            }
        });
    }

    function attachListeners(row) {
        row.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', () => {
                calculateRow(row);
                calculateGrandTotal();
            });
        });

        const removeBtn = row.querySelector('.remove-row');
        // Prevent multiple listeners
        removeBtn.replaceWith(removeBtn.cloneNode(true));
        row.querySelector('.remove-row').addEventListener('click', function() {
            if (tableBody.querySelectorAll('tr').length > 1) {
                row.remove();
                updateRowNumbers();
                calculateGrandTotal();
            }
        });

        // Add autocomplete for description field
        attachProductAutocomplete(row);
    }

    function updateRowNumbers() {
        tableBody.querySelectorAll('tr').forEach((row, index) => {
            row.querySelector('td:first-child').textContent = index + 1;
        });
    }

    addRowBtn.addEventListener('click', function() {
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td class="p-3 text-center text-gray-500"></td>
            <td class="p-3 relative">
                <input type="text" name="item_description[]" class="w-full rounded border-gray-200 dark:border-gray-600 p-1.5 focus:ring-1 focus:ring-blue-500" required placeholder="‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤...">
                <input type="hidden" name="item_product_id[]" value="">
            </td>
            <td class="p-3">
                <input type="number" step="any" name="item_quantity[]" value="1" class="qty-input w-full text-center rounded border-gray-200 dark:border-gray-600 p-1.5" min="1">
            </td>
            <td class="p-3">
                <input type="number" step="any" name="item_unit_price[]" value="0" class="price-input w-full text-right rounded border-gray-200 dark:border-gray-600 p-1.5">
            </td>
            <td class="p-3 text-right font-medium text-gray-900 row-total">0</td>
            <td class="p-3 text-center">
                <button type="button" class="remove-row text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
            </td>
        `;
        tableBody.appendChild(newRow);
        updateRowNumbers();
        attachListeners(newRow);
    });

    // Initialize existing rows
    document.querySelectorAll('#itemsTable tbody tr').forEach(attachListeners);
    calculateGrandTotal();
});
</script>
{% endblock %}
