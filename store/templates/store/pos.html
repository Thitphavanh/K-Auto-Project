{% extends 'base.html' %}
{% load static %}

{% block title %}‡∫Ç‡∫≤‡∫ç‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤ (POS Pro) - K-Auto Parts{% endblock %}

{% block extra_css %}
<style>
    /* Modern Retail POS Style - Like 7-Eleven, Big C, Lotus */
    .pos-container { max-width: 1800px; margin: 20px auto; padding: 0 15px; }
    .pos-layout { display: grid; grid-template-columns: 1fr 380px; gap: 20px; }

    @media (max-width: 1024px) {
        .pos-layout { grid-template-columns: 1fr; }
    }

    .pos-card {
        background: white; border-radius: 16px; padding: 25px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.08);
    }
    .dark-mode .pos-card { background: #1a1a1a; box-shadow: 0 6px 20px rgba(255,255,255,0.08); }

    /* Header Section */
    .pos-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .pos-header h1 { margin: 0; font-size: 1.8rem; }
    .pos-header .store-name { font-size: 0.9rem; opacity: 0.9; }

    /* Total Display - Like Retail Cash Register */
    .total-section {
        background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
        color: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .total-label { font-size: 0.9rem; opacity: 0.9; margin-bottom: 5px; }
    .total-display {
        background: #000;
        color: #0f0;
        font-family: 'Courier New', monospace;
        font-size: 2.5rem;
        text-align: right;
        padding: 15px 20px;
        border-radius: 8px;
        font-weight: bold;
        border: 3px solid #0f0;
        box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
    }

    /* Barcode Scanner Input */
    .scanner-section {
        background: #f8fafc;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
    }
    .dark-mode .scanner-section { background: #2d2d2d; }

    .barcode-input {
        font-size: 1.3rem;
        padding: 15px 20px;
        width: 100%;
        border: 3px solid #3b82f6;
        border-radius: 10px;
        outline: none;
        font-weight: 500;
        transition: all 0.3s;
    }
    .barcode-input:focus {
        border-color: #2563eb;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }

    /* Cart Items - Modern Card Style */
    .cart-items {
        max-height: calc(100vh - 500px);
        overflow-y: auto;
        padding: 10px;
    }

    .cart-item {
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 15px;
        display: grid;
        grid-template-columns: 80px 1fr auto;
        gap: 15px;
        align-items: center;
        transition: all 0.3s;
    }
    .cart-item:hover {
        border-color: #3b82f6;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    }
    .dark-mode .cart-item {
        background: #2d2d2d;
        border-color: #444;
    }

    .cart-item-image {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 8px;
        border: 2px solid #e5e7eb;
        background: #f9fafb;
    }
    .dark-mode .cart-item-image { background: #1a1a1a; border-color: #444; }

    .cart-item-info {
        flex: 1;
    }
    .cart-item-name {
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 5px;
        color: #1f2937;
    }
    .dark-mode .cart-item-name { color: #f3f4f6; }

    .cart-item-price {
        color: #3b82f6;
        font-weight: 700;
        font-size: 1.2rem;
    }

    .cart-item-controls {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 10px;
    }

    .qty-controls {
        display: flex;
        align-items: center;
        gap: 10px;
        background: #f3f4f6;
        padding: 8px 12px;
        border-radius: 8px;
    }
    .dark-mode .qty-controls { background: #374151; }

    .qty-btn {
        width: 32px;
        height: 32px;
        border: none;
        border-radius: 6px;
        background: #3b82f6;
        color: white;
        font-size: 1.2rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }
    .qty-btn:hover { background: #2563eb; transform: scale(1.05); }
    .qty-btn:active { transform: scale(0.95); }

    .qty-display {
        min-width: 35px;
        text-align: center;
        font-weight: 700;
        font-size: 1.1rem;
    }

    .item-total {
        font-weight: 700;
        font-size: 1.3rem;
        color: #059669;
    }

    .btn-remove {
        background: #ef4444;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
    }
    .btn-remove:hover { background: #dc2626; transform: scale(1.05); }

    /* Empty Cart Message */
    .empty-cart {
        text-align: center;
        padding: 60px 20px;
        color: #9ca3af;
    }
    .empty-cart-icon { font-size: 4rem; margin-bottom: 15px; }

    /* Command Buttons - Retail Style */
    .command-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 20px;
    }

    .btn-cmd {
        padding: 20px;
        border: none;
        border-radius: 12px;
        font-size: 1.3rem;
        font-weight: bold;
        cursor: pointer;
        color: white;
        transition: all 0.2s;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
    }
    .btn-cmd:active { transform: scale(0.97); }
    .btn-cmd span { font-size: 2rem; }

    .btn-pay {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        box-shadow: 0 6px 15px rgba(16, 185, 129, 0.3);
    }
    .btn-pay:hover {
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
        box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
    }

    .btn-clear {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        box-shadow: 0 6px 15px rgba(239, 68, 68, 0.3);
    }
    .btn-clear:hover {
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
    }

    /* Status Message */
    #status-msg {
        padding: 12px;
        border-radius: 8px;
        font-weight: 600;
        text-align: center;
        margin-top: 10px;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Summary Panel */
    .summary-panel {
        background: white;
        border-radius: 16px;
        padding: 25px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.08);
        position: sticky;
        top: 20px;
    }
    .dark-mode .summary-panel { background: #1a1a1a; }

    .summary-items {
        border-top: 2px dashed #e5e7eb;
        margin-top: 20px;
        padding-top: 20px;
    }
    .summary-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
        font-size: 1.1rem;
    }
    .summary-row.total {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1e40af;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 2px solid #e5e7eb;
    }

    /* Product Preview Toast */
    .product-preview {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        display: none;
        z-index: 1000;
        max-width: 350px;
        animation: slideIn 0.3s ease;
    }
    @keyframes slideIn {
        from { transform: translateX(400px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    .dark-mode .product-preview { background: #2d2d2d; }

    .preview-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-radius: 8px;
        margin-bottom: 15px;
    }
    .preview-name {
        font-size: 1.2rem;
        font-weight: 700;
        margin-bottom: 10px;
    }
    .preview-price {
        font-size: 1.5rem;
        color: #10b981;
        font-weight: 700;
    }

    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        animation: fadeIn 0.3s ease;
    }
    .modal-overlay.active { display: flex; }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideUp {
        from { transform: translateY(50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    .modal-content {
        background: white;
        border-radius: 20px;
        padding: 0;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.3s ease;
    }
    .dark-mode .modal-content { background: #1a1a1a; }

    .modal-header {
        padding: 25px;
        border-radius: 20px 20px 0 0;
        text-align: center;
        position: relative;
    }
    .modal-header.success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }
    .modal-header.warning {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
    }
    .modal-header.danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
    }

    .modal-icon {
        font-size: 4rem;
        margin-bottom: 10px;
        display: block;
    }

    .modal-title {
        font-size: 1.8rem;
        font-weight: 700;
        margin: 0;
    }

    .modal-subtitle {
        font-size: 1rem;
        opacity: 0.9;
        margin-top: 5px;
    }

    .modal-body {
        padding: 30px;
    }

    .modal-receipt {
        background: #f9fafb;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .dark-mode .modal-receipt { background: #2d2d2d; }

    .receipt-row {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px dashed #e5e7eb;
    }
    .dark-mode .receipt-row { border-color: #444; }

    .receipt-row:last-child { border-bottom: none; }

    .receipt-label {
        font-weight: 600;
        color: #6b7280;
    }
    .dark-mode .receipt-label { color: #9ca3af; }

    .receipt-value {
        font-weight: 700;
        color: #1f2937;
    }
    .dark-mode .receipt-value { color: #f3f4f6; }

    .receipt-total {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 2px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .dark-mode .receipt-total { border-color: #444; }

    .receipt-total .label {
        font-size: 1.3rem;
        font-weight: 700;
        color: #1e40af;
    }
    .dark-mode .receipt-total .label { color: #60a5fa; }

    .receipt-total .value {
        font-size: 2rem;
        font-weight: 700;
        color: #10b981;
    }

    .receipt-items {
        margin-top: 20px;
    }

    .receipt-item {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #e5e7eb;
    }
    .dark-mode .receipt-item { border-color: #444; }

    .receipt-item-name {
        flex: 1;
        font-weight: 600;
    }

    .receipt-item-qty {
        margin: 0 15px;
        color: #6b7280;
    }

    .receipt-item-price {
        font-weight: 700;
        color: #059669;
        min-width: 100px;
        text-align: right;
    }

    .modal-message {
        text-align: center;
        font-size: 1.2rem;
        line-height: 1.6;
        color: #4b5563;
        margin-bottom: 20px;
    }
    .dark-mode .modal-message { color: #d1d5db; }

    .modal-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 25px;
    }

    .modal-btn {
        padding: 15px 30px;
        border: none;
        border-radius: 12px;
        font-size: 1.1rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s;
    }

    .modal-btn-primary {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    .modal-btn-primary:hover {
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
    }

    .modal-btn-danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }
    .modal-btn-danger:hover {
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
    }

    .modal-btn-secondary {
        background: #e5e7eb;
        color: #374151;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    .modal-btn-secondary:hover {
        background: #d1d5db;
        transform: translateY(-2px);
    }
    .dark-mode .modal-btn-secondary {
        background: #374151;
        color: #f3f4f6;
    }

    .modal-btn-full {
        grid-column: 1 / -1;
    }

    /* Customer Autocomplete */
    .customer-search-wrapper {
        position: relative;
    }

    .customer-autocomplete {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 2px solid #3b82f6;
        border-top: none;
        border-radius: 0 0 10px 10px;
        max-height: 250px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        display: none;
    }
    .dark-mode .customer-autocomplete { background: #2d2d2d; border-color: #3b82f6; }

    .customer-autocomplete.active {
        display: block;
    }

    .autocomplete-item {
        padding: 12px 15px;
        cursor: pointer;
        border-bottom: 1px solid #e5e7eb;
        transition: background 0.2s;
    }
    .dark-mode .autocomplete-item { border-color: #444; }

    .autocomplete-item:hover {
        background: #dbeafe;
    }
    .dark-mode .autocomplete-item:hover { background: #374151; }

    .autocomplete-item:last-child {
        border-bottom: none;
    }

    .autocomplete-name {
        font-weight: 600;
        font-size: 1rem;
        color: #1f2937;
        margin-bottom: 3px;
    }
    .dark-mode .autocomplete-name { color: #f3f4f6; }

    .autocomplete-phone {
        font-size: 0.9rem;
        color: #6b7280;
    }
    .dark-mode .autocomplete-phone { color: #9ca3af; }

    .autocomplete-car {
        font-size: 0.85rem;
        color: #3b82f6;
        margin-top: 3px;
    }

</style>
{% endblock %}

{% block content %}
<div class="pos-container">
    <div class="pos-layout">
        <!-- Left Panel: Cart Items -->
        <div class="pos-card">
            <!-- Header -->
            <div class="pos-header">
                <div>
                    <h1>üõí ‡∫Ç‡∫≤‡∫ç‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤ (POS)</h1>
                    <div class="store-name">K-Auto Parts Store</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 0.9rem;">‡∫ú‡∫π‡ªâ‡∫Ç‡∫≤‡∫ç:</div>
                    <div style="font-weight: 700;">{{ request.user.username }}</div>
                </div>
            </div>

            <!-- Scanner Section -->
            <div class="scanner-section">
                <input type="text" id="barcode" class="barcode-input"
                       placeholder="üîç ‡∫ç‡∫¥‡∫á‡∫ö‡∫≤‡ªÇ‡∫Ñ‡∫î‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤ ‡∫´‡∫º‡∫∑ ‡∫û‡∫¥‡∫°‡∫Ñ‡∫≥‡∫™‡∫±‡ªà‡∫á (CMD-PAY, CMD-CLEAR)..."
                       autofocus autocomplete="off">
                <div id="status-msg"></div>
            </div>

            <!-- Cart Items -->
            <div class="cart-items" id="cart-items">
                <div class="empty-cart">
                    <div class="empty-cart-icon">üõí</div>
                    <div style="font-size: 1.2rem; font-weight: 600;">‡∫Å‡∫∞‡∫ï‡ªà‡∫≤‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤‡∫ß‡ªà‡∫≤‡∫á‡ªÄ‡∫õ‡∫ª‡ªà‡∫≤</div>
                    <div style="margin-top: 8px;">‡∫ç‡∫¥‡∫á‡∫ö‡∫≤‡ªÇ‡∫Ñ‡∫î‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡ªÄ‡∫•‡∫µ‡ªà‡∫°‡∫Ç‡∫≤‡∫ç</div>
                </div>
            </div>
        </div>

        <!-- Right Panel: Summary & Actions -->
        <div class="summary-panel">
            <div class="total-section">
                <div class="total-label">üí∞ ‡∫ç‡∫≠‡∫î‡∫•‡∫ß‡∫°‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î</div>
                <div class="total-display" id="grand-total">0.00</div>
                <div style="text-align: center; margin-top: 10px; font-size: 0.9rem;">‡∏ø ‡∫ö‡∫≤‡∫î (THB)</div>
            </div>

            <!-- Customer & Vehicle Info -->
            <div class="pos-card" style="padding: 15px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 5px; margin-bottom: 10px;">
                    <h3 style="margin: 0; font-size: 1.1rem;">üë§ ‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤ (Customer)</h3>
                    <a href="{% url 'customer-registration' %}" target="_blank" style="font-size: 0.75rem; color: #dc2626; font-weight: 700; text-decoration: none; background: #fff1f2; padding: 2px 8px; border-radius: 6px; border: 1px solid #fecaca;">+ ‡∫•‡∫ª‡∫á‡∫ó‡∫∞‡∫ö‡∫Ω‡∫ô‡ªÉ‡ªù‡ªà</a>
                </div>
                <div style="display: grid; gap: 10px;">
                    <!-- Search -->
                    <div class="customer-search-wrapper">
                        <input type="text" id="cust-search" placeholder="üîç ‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤ (‡∫ä‡∫∑‡ªà/‡ªÄ‡∫ö‡∫µ‡ªÇ‡∫ó)" class="barcode-input" style="font-size: 1rem; padding: 8px;" autocomplete="off">
                        <div id="customer-autocomplete" class="customer-autocomplete"></div>
                    </div>

                    <!-- Service Info Inputs -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <div>
                            <label style="font-size: 0.8rem; font-weight: 600; color: #6b7280; display: block; margin-bottom: 2px;">‡∫ä‡ªà‡∫≤‡∫á‡∫™‡ªâ‡∫≠‡∫° / Mechanic</label>
                            <input type="text" id="mech-name" placeholder="‡∫ä‡∫∑‡ªà‡∫ä‡ªà‡∫≤‡∫á..." class="barcode-input" style="font-size: 0.9rem; padding: 6px; border-width: 2px;">
                        </div>
                        <div>
                            <label style="font-size: 0.8rem; font-weight: 600; color: #6b7280; display: block; margin-bottom: 2px;">‡∫û‡∫∞‡∫ô‡∫±‡∫Å‡∫á‡∫≤‡∫ô‡∫Ç‡∫≤‡∫ç / Sales Rep</label>
                            <input type="text" id="sale-rep" value="{{ request.user.username }}" placeholder="‡∫ä‡∫∑‡ªà..." class="barcode-input" style="font-size: 0.9rem; padding: 6px; border-width: 2px;">
                        </div>
                    </div>

                    <!-- Selected Customer Display -->
                    <div id="selected-customer-display" style="display: none; background: #fff; padding: 12px; border-radius: 12px; border: 2px solid #fee2e2; box-shadow: 0 4px 6px -1px rgba(220, 38, 38, 0.05);">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                    <span id="display-name" style="font-weight: 800; color: #111827; font-size: 1.1rem;"></span>
                                    <span id="display-code" style="background: #fef2f2; color: #dc2626; font-size: 0.75rem; font-weight: 900; padding: 2px 8px; border-radius: 6px; border: 1px solid #fecaca;"></span>
                                </div>
                                <div id="display-phone" style="font-size: 0.95rem; color: #4b5563; font-weight: 500;"></div>
                                <div id="display-car" style="font-size: 0.9rem; color: #b91c1c; font-weight: 700; margin-top: 6px; display: flex; align-items: center; gap: 6px;">
                                    <span id="display-car-info"></span>
                                </div>
                            </div>
                            <button type="button" onclick="clearSelectedCustomer()" style="background: #f3f4f6; border: none; color: #6b7280; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: all 0.2s;">&times;</button>
                        </div>
                    </div>

                    <!-- Hidden Inputs for Checkout Logic -->
                    <input type="hidden" id="cust-code">
                    <input type="hidden" id="cust-name">
                    <input type="hidden" id="cust-phone">
                    <input type="hidden" id="car-reg">
                    <input type="hidden" id="car-prov">
                    <input type="hidden" id="car-mileage">
                    <input type="hidden" id="car-brand">
                    <input type="hidden" id="car-model">
                    <input type="hidden" id="car-frame">
                    <input type="hidden" id="car-color">

                    <!-- Hidden Inputs for Checkout Logic -->
                </div>
            </div>

            <div class="summary-items">
                <div class="summary-row">
                    <span>üì¶ ‡∫à‡∫≥‡∫ô‡∫ß‡∫ô‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô:</span>
                    <span id="item-count">0</span>
                </div>
                <div class="summary-row">
                    <span>üî¢ ‡∫à‡∫≥‡∫ô‡∫ß‡∫ô‡∫ä‡∫¥‡ªâ‡∫ô:</span>
                    <span id="total-qty">0</span>
                </div>
                <div class="summary-row total">
                    <span>‡∫•‡∫ß‡∫°‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î:</span>
                    <span id="grand-total-summary">0.00 ‡∏ø</span>
                </div>
            </div>

            <!-- Command Buttons -->
            <div class="command-section">
                <button onclick="handleCommand('CMD-PAY')" class="btn-cmd btn-pay">
                    <span>üí∞</span>
                    <div>‡∫Ñ‡∫¥‡∫î‡ªÄ‡∫á‡∫¥‡∫ô</div>
                </button>

                <button onclick="handleCommand('CMD-CLEAR')" class="btn-cmd btn-clear">
                    <span>üóëÔ∏è</span>
                    <div>‡∫•‡ªâ‡∫≤‡∫á‡∫ö‡∫¥‡∫ô</div>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Product Preview Toast (shows when scanning) -->
<div class="product-preview" id="product-preview">
    <img id="preview-img" class="preview-image" src="" alt="">
    <div class="preview-name" id="preview-name"></div>
    <div class="preview-price" id="preview-price"></div>
</div>

<!-- Checkout Modal -->
<div class="modal-overlay" id="checkout-modal">
    <div class="modal-content">
        <div class="modal-header success">
            <span class="modal-icon">üí∞</span>
            <h2 class="modal-title">‡∫¢‡∫∑‡∫ô‡∫¢‡∫±‡∫ô‡∫Å‡∫≤‡∫ô‡∫Ç‡∫≤‡∫ç</h2>
            <div class="modal-subtitle">‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫Å‡∫ß‡∫î‡∫™‡∫≠‡∫ö‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô‡∫Å‡ªà‡∫≠‡∫ô‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å</div>
        </div>
        <div class="modal-body">
            <!-- Receipt Summary -->
            <div class="modal-receipt">
                <div class="receipt-row">
                    <span class="receipt-label">üì¶ ‡∫à‡∫≥‡∫ô‡∫ß‡∫ô‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô:</span>
                    <span class="receipt-value" id="modal-item-count">0</span>
                </div>
                <div class="receipt-row">
                    <span class="receipt-label">üî¢ ‡∫à‡∫≥‡∫ô‡∫ß‡∫ô‡∫ä‡∫¥‡ªâ‡∫ô:</span>
                    <span class="receipt-value" id="modal-total-qty">0</span>
                </div>
                <div class="receipt-total">
                    <span class="label">üíµ ‡∫ç‡∫≠‡∫î‡∫•‡∫ß‡∫°‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î:</span>
                    <span class="value" id="modal-grand-total">0</span>
                </div>
            </div>

            <!-- Items List -->
            <div class="receipt-items" id="modal-items-list"></div>

            <!-- Actions -->
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" onclick="closeCheckoutModal()">
                    ‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å
                </button>
                <button class="modal-btn modal-btn-primary" onclick="confirmCheckout()">
                    ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫Å‡∫≤‡∫ô‡∫Ç‡∫≤‡∫ç
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal-overlay" id="success-modal">
    <div class="modal-content">
        <div class="modal-header success">
            <span class="modal-icon">‚úÖ</span>
            <h2 class="modal-title">‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î!</h2>
            <div class="modal-subtitle">‡∫Å‡∫≤‡∫ô‡∫Ç‡∫≤‡∫ç‡∫ñ‡∫∑‡∫Å‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡ªÅ‡∫•‡ªâ‡∫ß</div>
        </div>
        <div class="modal-body">
            <div class="modal-receipt">
                <div class="receipt-total">
                    <span class="label">üí∞ ‡∫ç‡∫≠‡∫î‡∫•‡∫ß‡∫°:</span>
                    <span class="value" id="success-total">0</span>
                </div>
            </div>
            <div class="modal-message">
                <p>üéâ ‡∫Ç‡∫≠‡∫ö‡ªÉ‡∫à‡∫ó‡∫µ‡ªà‡ªÉ‡∫ä‡ªâ‡∫ö‡ªç‡∫•‡∫¥‡∫Å‡∫≤‡∫ô!</p>
                <p style="font-size: 1rem; margin-top: 10px;">‡∫û‡ªâ‡∫≠‡∫°‡∫Æ‡∫±‡∫ö‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤‡∫Ñ‡∫ª‡∫ô‡∫ï‡ªç‡ªà‡ªÑ‡∫õ‡ªÅ‡∫•‡ªâ‡∫ß</p>
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-primary modal-btn-full" onclick="closeSuccessModal()">
                    ‡ªÄ‡∫•‡∫µ‡ªà‡∫°‡∫Ç‡∫≤‡∫ç‡∫ï‡ªç‡ªà
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Clear Cart Modal -->
<div class="modal-overlay" id="clear-modal">
    <div class="modal-content">
        <div class="modal-header warning">
            <span class="modal-icon">‚ö†Ô∏è</span>
            <h2 class="modal-title">‡∫•‡ªâ‡∫≤‡∫á‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô?</h2>
            <div class="modal-subtitle">‡∫Å‡∫≤‡∫ô‡∫Å‡∫∞‡∫ó‡∫≥‡∫ô‡∫µ‡ªâ‡∫ö‡ªç‡ªà‡∫™‡∫≤‡∫°‡∫≤‡∫î‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å‡ªÑ‡∫î‡ªâ</div>
        </div>
        <div class="modal-body">
            <div class="modal-message">
                <p><strong>‡∫ï‡ªâ‡∫≠‡∫á‡∫Å‡∫≤‡∫ô‡∫•‡ªâ‡∫≤‡∫á‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î‡ªÅ‡∫ó‡ªâ‡∫ö‡ªç‡ªà?</strong></p>
                <p style="font-size: 1rem; margin-top: 10px; color: #dc2626;">
                    ‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î <span id="clear-item-count" style="font-weight: 700;">0</span> ‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô‡∫à‡∫∞‡∫ñ‡∫∑‡∫Å‡∫•‡∫∂‡∫ö
                </p>
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" onclick="closeClearModal()">
                    ‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å
                </button>
                <button class="modal-btn modal-btn-danger" onclick="confirmClear()">
                    üóëÔ∏è ‡∫•‡ªâ‡∫≤‡∫á‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Item Modal -->
<div class="modal-overlay" id="delete-modal">
    <div class="modal-content">
        <div class="modal-header danger">
            <span class="modal-icon">üóëÔ∏è</span>
            <h2 class="modal-title">‡∫•‡∫∂‡∫ö‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô?</h2>
            <div class="modal-subtitle">‡∫ï‡ªâ‡∫≠‡∫á‡∫Å‡∫≤‡∫ô‡∫•‡∫∂‡∫ö‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤‡∫ô‡∫µ‡ªâ‡∫≠‡∫≠‡∫Å‡∫à‡∫≤‡∫Å‡∫ö‡∫¥‡∫ô‡∫ö‡ªç‡ªà?</div>
        </div>
        <div class="modal-body">
            <div class="modal-message">
                <p id="delete-item-name" style="font-weight: 700; color: #1f2937;"></p>
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" onclick="closeDeleteModal()">
                    ‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å
                </button>
                <button class="modal-btn modal-btn-danger" onclick="confirmDelete()">
                    ‡∫•‡∫∂‡∫ö‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô
                </button>
            </div>
        </div>
    </div>
</div>

<audio id="sound-beep" src="https://actions.google.com/sounds/v1/cartoon/pop.ogg"></audio>
<audio id="sound-error" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
<audio id="sound-cash" src="https://actions.google.com/sounds/v1/cartoon/clown_horn.ogg"></audio>

{% endblock %}

{% block extra_js %}
<script>
    const CART_STORAGE_KEY = 'k_auto_pos_cart'; // localStorage key
    let cart = []; // ‡∫Å‡∫∞‡∫ï‡ªà‡∫≤‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤‡ªÉ‡∫ô‡ªú‡ªà‡∫ß‡∫ç‡∫Ñ‡∫ß‡∫≤‡∫°‡∫à‡∫≥

    const input = document.getElementById('barcode');
    const cartItems = document.getElementById('cart-items');
    const totalDisplay = document.getElementById('grand-total');
    const totalSummary = document.getElementById('grand-total-summary');
    const itemCount = document.getElementById('item-count');
    const totalQty = document.getElementById('total-qty');
    const msgDisplay = document.getElementById('status-msg');
    const productPreview = document.getElementById('product-preview');

    // ‡∫™‡∫Ω‡∫á
    const beep = document.getElementById('sound-beep');
    const errorSound = document.getElementById('sound-error');
    const cashSound = document.getElementById('sound-cash');

    // === localStorage Functions ===
    function saveCart() {
        try {
            localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(cart));
            console.log('üíæ Cart saved to localStorage');
        } catch (error) {
            console.error('Error saving cart:', error);
        }
    }

    function loadCart() {
        try {
            const savedCart = localStorage.getItem(CART_STORAGE_KEY);
            if (savedCart) {
                cart = JSON.parse(savedCart);
                console.log('‚úÖ Cart loaded from localStorage:', cart.length, 'items');
                if (cart.length > 0) {
                    showMsg(`üîÑ ‡∫Å‡∫π‡ªâ‡∫Ñ‡∫∑‡∫ô‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô ${cart.length} ‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô`, false);
                }
            }
        } catch (error) {
            console.error('Error loading cart:', error);
            cart = [];
        }
    }

    function clearCartStorage() {
        try {
            localStorage.removeItem(CART_STORAGE_KEY);
            console.log('üóëÔ∏è Cart storage cleared');
        } catch (error) {
            console.error('Error clearing cart storage:', error);
        }
    }

    // Load cart on page load
    loadCart();

    // === Customer Autocomplete ===
    const custSearch = document.getElementById('cust-search');
    const custAutocomplete = document.getElementById('customer-autocomplete');
    let searchTimeout;
    let selectedCustomer = null;

    // ‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤
    custSearch.addEventListener('input', function(e) {
        const query = e.target.value.trim();

        if (query.length < 2) {
            custAutocomplete.classList.remove('active');
            custAutocomplete.innerHTML = '';
            return;
        }

        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            fetch(`/api/search-customer/?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.results && data.results.length > 0) {
                        let html = '';
                        data.results.forEach(customer => {
                            const carInfo = customer.car_brand && customer.car_model
                                ? `üöó ${customer.car_brand} ${customer.car_model} - ${customer.car_register_no || ''}`
                                : '';

                            html += `
                                <div class="autocomplete-item" data-customer='${JSON.stringify(customer)}'>
                                    <div class="autocomplete-name">${customer.name || 'N/A'}</div>
                                    <div class="autocomplete-phone">üì± ${customer.phone || 'N/A'}</div>
                                    ${carInfo ? `<div class="autocomplete-car">${carInfo}</div>` : ''}
                                </div>
                            `;
                        });
                        custAutocomplete.innerHTML = html;
                        custAutocomplete.classList.add('active');

                        // ‡ªÄ‡∫û‡∫µ‡ªà‡∫° event listener ‡∫™‡∫≥‡∫•‡∫±‡∫ö‡ªÅ‡∫ï‡ªà‡∫•‡∫∞‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô
                        document.querySelectorAll('.autocomplete-item').forEach(item => {
                            item.addEventListener('click', function() {
                                const customer = JSON.parse(this.dataset.customer);
                                fillCustomerData(customer);
                                custAutocomplete.classList.remove('active');
                                custSearch.value = '';
                            });
                        });
                    } else {
                        custAutocomplete.classList.remove('active');
                    }
                })
                .catch(err => {
                    console.error('Error searching customer:', err);
                    custAutocomplete.classList.remove('active');
                });
        }, 300); // Debounce 300ms
    });

    // ‡∫õ‡∫¥‡∫î autocomplete ‡ªÄ‡∫°‡∫∑‡ªà‡∫≠‡∫Ñ‡∫•‡∫¥‡∫Å‡∫ô‡∫≠‡∫Å
    document.addEventListener('click', function(e) {
        if (!custSearch.contains(e.target) && !custAutocomplete.contains(e.target)) {
            custAutocomplete.classList.remove('active');
        }
    });

    // ‡∫ü‡∫±‡∫á‡∫ä‡∫±‡∫ô‡∫ï‡∫∑‡ªà‡∫°‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤
    function fillCustomerData(customer) {
        document.getElementById('cust-code').value = customer.code || '';
        document.getElementById('cust-name').value = customer.name || '';
        document.getElementById('cust-phone').value = customer.phone || '';
        document.getElementById('car-reg').value = customer.car_register_no || '';
        document.getElementById('car-prov').value = customer.car_province || '';
        document.getElementById('car-brand').value = customer.car_brand || '';
        document.getElementById('car-model').value = customer.car_model || '';
        document.getElementById('car-frame').value = customer.car_frame_no || '';
        document.getElementById('car-color').value = customer.car_color || '';
        document.getElementById('mech-name').value = customer.mechanic_name || '';
        document.getElementById('sale-rep').value = customer.sale_representative || '{{ request.user.username }}';

        // Update Display UI
        document.getElementById('display-name').innerText = customer.name || 'Unknown';
        document.getElementById('display-code').innerText = customer.code || '';
        document.getElementById('display-phone').innerText = 'üì± ' + (customer.phone || 'N/A');
        
        const carInfoText = customer.car_brand || customer.car_register_no 
            ? `üöó ${customer.car_brand || ''} ${customer.car_model || ''} [${customer.car_register_no || '-'}]`
            : 'üöó No vehicle info';
        document.getElementById('display-car-info').innerText = carInfoText;
        
        document.getElementById('selected-customer-display').style.display = 'block';

        selectedCustomer = customer;
        showMsg(`‚úÖ ‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤: ${customer.name} (${customer.code})`, false);
    }

    window.clearSelectedCustomer = function() {
        document.getElementById('cust-code').value = '';
        document.getElementById('cust-name').value = '';
        document.getElementById('cust-phone').value = '';
        document.getElementById('car-reg').value = '';
        document.getElementById('car-prov').value = '';
        document.getElementById('car-brand').value = '';
        document.getElementById('car-model').value = '';
        document.getElementById('car-frame').value = '';
        document.getElementById('car-color').value = '';
        document.getElementById('car-mileage').value = '';
        document.getElementById('mech-name').value = '';
        document.getElementById('sale-rep').value = '{{ request.user.username }}';
        
        document.getElementById('selected-customer-display').style.display = 'none';
        selectedCustomer = null;
        input.focus();
    }

    // Focus ‡∫ä‡ªà‡∫≠‡∫á‡∫ç‡∫¥‡∫á‡∫ï‡∫∞‡∫´‡∫º‡∫≠‡∫î‡ªÄ‡∫ß‡∫•‡∫≤ (‡∫ç‡∫ª‡∫Å‡ªÄ‡∫ß‡∫±‡ªâ‡∫ô‡∫ï‡∫≠‡∫ô‡∫Å‡∫≥‡∫•‡∫±‡∫á‡∫û‡∫¥‡∫°‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫≠‡∫∑‡ªà‡∫ô)
    input.focus();
    document.addEventListener('click', (e) => {
        // ‡∫ñ‡ªâ‡∫≤‡∫ö‡ªç‡ªà‡ªÑ‡∫î‡ªâ‡∫Ñ‡∫•‡∫¥‡∫Å‡ªÉ‡∫™‡ªà input ‡∫´‡∫º‡∫∑ select ‡∫´‡∫º‡∫∑ textarea ‡ªÉ‡∫´‡ªâ focus ‡∫ó‡∫µ‡ªà‡∫ä‡ªà‡∫≠‡∫á barcode
        if (!['INPUT', 'SELECT', 'TEXTAREA'].includes(e.target.tagName)) {
            input.focus();
        }
    });

    // ‡∫î‡∫±‡∫Å‡∫à‡∫±‡∫ö‡∫Å‡∫≤‡∫ô‡∫ç‡∫¥‡∫á‡∫ö‡∫≤‡ªÇ‡∫Ñ‡∫î
    input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            let code = input.value.trim();

            if(code) {
                if (code.toUpperCase().startsWith('CMD-')) {
                    handleCommand(code); // ‡∫ñ‡ªâ‡∫≤‡ªÄ‡∫õ‡∫±‡∫ô‡∫Ñ‡∫≥‡∫™‡∫±‡ªà‡∫á
                } else {
                    addToCart(code); // ‡∫ñ‡ªâ‡∫≤‡ªÄ‡∫õ‡∫±‡∫ô‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤
                }
            }
            input.value = '';
        }
    });

    // Modal Elements
    const checkoutModal = document.getElementById('checkout-modal');
    const successModal = document.getElementById('success-modal');
    const clearModal = document.getElementById('clear-modal');
    const deleteModal = document.getElementById('delete-modal');
    let itemToDelete = null;

    // === Logic ‡∫à‡∫±‡∫î‡∫Å‡∫≤‡∫ô‡∫Ñ‡∫≥‡∫™‡∫±‡ªà‡∫á (Magic Sheet & Buttons) ===
    window.handleCommand = function(cmd) {
        cmd = cmd.toUpperCase();
        if (cmd === 'CMD-PAY') {
            if (cart.length > 0) {
                processCheckout();
            } else {
                showMsg('‚ùå ‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤', true);
                input.focus();
            }
        } else if (cmd === 'CMD-CLEAR') {
            openClearModal();
        } else {
            showMsg('‚ùå ‡∫ö‡ªç‡ªà‡∫Æ‡∫π‡ªâ‡∫à‡∫±‡∫Å‡∫Ñ‡∫≥‡∫™‡∫±‡ªà‡∫á: ' + cmd, true);
            input.focus();
        }
    }

    // === Logic ‡∫î‡∫∂‡∫á‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤ ===
    function addToCart(barcode) {
        let existingItem = cart.find(item => item.barcode === barcode);

        if (existingItem) {
            existingItem.qty += 1;
            renderCart();
            beep.play();
            showMsg(`‚úÖ ‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫à‡∫≥‡∫ô‡∫ß‡∫ô: ${existingItem.name}`, false);
        } else {
            fetch(`/api/get-product/?barcode=${barcode}`)
                .then(response => response.json())
                .then(data => {
                    if (data.found) {
                        if (data.stock > 0) {
                            // Show product preview
                            showProductPreview(data);

                            cart.push({
                                id: data.id,
                                barcode: barcode,
                                name: data.name,
                                price: data.price,
                                qty: 1,
                                image: data.image
                            });
                            renderCart();
                            beep.play();
                            showMsg(`üì¶ ‡ªÄ‡∫û‡∫µ‡ªà‡∫°: ${data.name}`, false);
                        } else {
                            showMsg(`‚ùå ‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤‡ªù‡∫ª‡∫î! (${data.name})`, true);
                        }
                    } else {
                        showMsg('‚ùå ‡∫ö‡ªç‡ªà‡∫û‡∫ª‡∫ö‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤!', true);
                    }
                })
                .catch(err => {
                    console.error(err);
                    showMsg('‚ùå ‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î‡ªÉ‡∫ô‡∫Å‡∫≤‡∫ô‡∫î‡∫∂‡∫á‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô', true);
                });
        }
    }

    // === Show Product Preview Toast ===
    function showProductPreview(product) {
        const defaultImg = 'https://via.placeholder.com/300x200?text=No+Image';
        document.getElementById('preview-img').src = product.image || defaultImg;
        document.getElementById('preview-name').innerText = product.name;
        document.getElementById('preview-price').innerText = product.price.toLocaleString() + ' ‡∏ø';

        productPreview.style.display = 'block';
        setTimeout(() => {
            productPreview.style.display = 'none';
        }, 3000);
    }

    // === ‡∫™‡∫∞‡ªÅ‡∫î‡∫á‡∫ú‡∫ª‡∫ô‡∫Å‡∫∞‡∫ï‡ªà‡∫≤‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤ (Modern Card Style) ===
    function renderCart() {
        if (cart.length === 0) {
            cartItems.innerHTML = `
                <div class="empty-cart">
                    <div class="empty-cart-icon">üõí</div>
                    <div style="font-size: 1.2rem; font-weight: 600;">‡∫Å‡∫∞‡∫ï‡ªà‡∫≤‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤‡∫ß‡ªà‡∫≤‡∫á‡ªÄ‡∫õ‡∫ª‡ªà‡∫≤</div>
                    <div style="margin-top: 8px;">‡∫ç‡∫¥‡∫á‡∫ö‡∫≤‡ªÇ‡∫Ñ‡∫î‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡ªÄ‡∫•‡∫µ‡ªà‡∫°‡∫Ç‡∫≤‡∫ç</div>
                </div>
            `;
            updateSummary(0, 0, 0);
            saveCart(); // Save to localStorage
            return;
        }

        let html = '';
        let grandTotal = 0;
        let totalItems = cart.length;
        let totalQuantity = 0;
        const defaultImg = 'https://via.placeholder.com/80?text=No+Image';

        cart.forEach((item, index) => {
            let itemTotal = item.price * item.qty;
            grandTotal += itemTotal;
            totalQuantity += item.qty;

            html += `
                <div class="cart-item">
                    <img src="${item.image || defaultImg}"
                         alt="${item.name}"
                         class="cart-item-image"
                         onerror="this.src='${defaultImg}'">

                    <div class="cart-item-info">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-price">${item.price.toLocaleString()} ‡∏ø</div>
                    </div>

                    <div class="cart-item-controls">
                        <div class="qty-controls">
                            <button onclick="updateQty(${index}, -1)" class="qty-btn">-</button>
                            <span class="qty-display">${item.qty}</span>
                            <button onclick="updateQty(${index}, 1)" class="qty-btn">+</button>
                        </div>
                        <div class="item-total">${itemTotal.toLocaleString()} ‡∏ø</div>
                        <button onclick="removeItem(${index})" class="btn-remove">‡∫•‡∫∂‡∫ö</button>
                    </div>
                </div>
            `;
        });

        cartItems.innerHTML = html;
        updateSummary(grandTotal, totalItems, totalQuantity);
        saveCart(); // Save to localStorage after rendering
    }

    // === Update Summary Panel ===
    function updateSummary(total, items, qty) {
        totalDisplay.innerText = total.toLocaleString();
        totalSummary.innerText = total.toLocaleString() + ' ‡∏ø';
        itemCount.innerText = items;
        totalQty.innerText = qty;
    }

    // === ‡∫ü‡∫±‡∫á‡∫ä‡∫±‡∫ô‡∫ä‡ªà‡∫ß‡∫ç‡ªÄ‡∫´‡∫º‡∫∑‡∫≠ ===
    window.updateQty = function(index, change) {
        if (cart[index].qty + change > 0) {
            cart[index].qty += change;
            renderCart();
            beep.play();
        } else if (cart[index].qty + change === 0) {
            openDeleteModal(index);
        }
        input.focus();
    }

    window.removeItem = function(index) {
        openDeleteModal(index);
        input.focus();
    }

    function showMsg(text, isError = false) {
        msgDisplay.innerText = text;
        msgDisplay.style.background = isError ? '#fee2e2' : '#dbeafe';
        msgDisplay.style.color = isError ? '#dc2626' : '#1e40af';
        if(isError) errorSound.play();

        // Auto clear message after 5 seconds
        setTimeout(() => {
            msgDisplay.innerText = '';
            msgDisplay.style.background = 'transparent';
        }, 5000);
    }

    // === ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫Å‡∫≤‡∫ô‡∫Ç‡∫≤‡∫ç (Checkout) ===
    function processCheckout() {
        const total = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
        const totalQtyValue = cart.reduce((sum, item) => sum + item.qty, 0);

        // Populate checkout modal
        document.getElementById('modal-item-count').innerText = cart.length;
        document.getElementById('modal-total-qty').innerText = totalQtyValue;
        document.getElementById('modal-grand-total').innerText = total.toLocaleString() + ' ‡∏ø';

        // Populate items list
        let itemsHTML = '';
        cart.forEach(item => {
            itemsHTML += `
                <div class="receipt-item">
                    <span class="receipt-item-name">${item.name}</span>
                    <span class="receipt-item-qty">x${item.qty}</span>
                    <span class="receipt-item-price">${(item.price * item.qty).toLocaleString()} ‡∏ø</span>
                </div>
            `;
        });
        document.getElementById('modal-items-list').innerHTML = itemsHTML;

        // Open modal
        checkoutModal.classList.add('active');
    }

    window.closeCheckoutModal = function() {
        checkoutModal.classList.remove('active');
        input.focus();
    }

    window.confirmCheckout = function() {
        const total = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
        
        const customerData = {
            name: document.getElementById('cust-name').value,
            phone: document.getElementById('cust-phone').value
        };
        const carData = {
            register_no: document.getElementById('car-reg').value,
            province: document.getElementById('car-prov').value,
            brand: document.getElementById('car-brand').value,
            model: document.getElementById('car-model').value,
            frame_no: document.getElementById('car-frame').value,
            color: document.getElementById('car-color').value,
            mileage: document.getElementById('car-mileage').value
        };
        const mechanicData = {
            mechanic: document.getElementById('mech-name').value,
            sale_rep: document.getElementById('sale-rep').value
        };

        checkoutModal.classList.remove('active');
        showMsg('‚è≥ ‡∫Å‡∫≥‡∫•‡∫±‡∫á‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å...', false);

        fetch('/api/checkout/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ 
                items: cart,
                customer: customerData,
                car: carData,
                mechanic: mechanicData
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                cashSound.play();

                // Clear cart and localStorage
                cart = [];
                clearCartStorage();
                renderCart();
                
                // Clear inputs
                document.getElementById('cust-code').value = '';
                document.getElementById('cust-name').value = '';
                document.getElementById('cust-phone').value = '';
                document.getElementById('car-reg').value = '';
                document.getElementById('car-prov').value = '';
                document.getElementById('car-brand').value = '';
                document.getElementById('car-model').value = '';
                document.getElementById('mech-name').value = '';

                // Show success modal with link to bill
                document.getElementById('success-total').innerText = total.toLocaleString() + ' ‡∏ø';
                const successMsg = document.querySelector('#success-modal .modal-message');
                successMsg.innerHTML = `
                    <p>üéâ ‡∫Ç‡∫≤‡∫ç‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î!</p>
                    <a href="/orders/${data.invoice_no}/" target="_blank" class="modal-btn modal-btn-primary" style="display: inline-block; text-decoration: none; margin-top: 15px;">
                        üìÑ ‡ªÄ‡∫ö‡∫¥‡ªà‡∫á‡ªÉ‡∫ö‡∫ö‡∫¥‡∫ô (View Bill)
                    </a>
                `;
                successModal.classList.add('active');
            } else {
                showMsg('‚ùå ‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î: ' + data.error, true);
                input.focus();
            }
        })
        .catch(err => {
            console.error(err);
            showMsg('‚ùå ‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î‡ªÉ‡∫ô‡∫Å‡∫≤‡∫ô‡ªÄ‡∫ä‡∫∑‡ªà‡∫≠‡∫°‡∫ï‡ªç‡ªà', true);
            input.focus();
        });
    }

    window.closeSuccessModal = function() {
        successModal.classList.remove('active');
        showMsg('‚úÖ ‡∫û‡ªâ‡∫≠‡∫°‡∫Ç‡∫≤‡∫ç‡∫ï‡ªç‡ªà‡ªÑ‡∫õ...', false);
        input.focus();
    }

    // === Clear Cart Modal ===
    function openClearModal() {
        document.getElementById('clear-item-count').innerText = cart.length;
        clearModal.classList.add('active');
    }

    window.closeClearModal = function() {
        clearModal.classList.remove('active');
        input.focus();
    }

    window.confirmClear = function() {
        cart = [];
        clearCartStorage();
        renderCart();
        clearModal.classList.remove('active');
        showMsg('üóëÔ∏è ‡∫•‡ªâ‡∫≤‡∫á‡∫ö‡∫¥‡∫ô‡∫Æ‡∫Ω‡∫ö‡∫Æ‡ªâ‡∫≠‡∫ç');
        input.focus();
    }

    // === Delete Item Modal ===
    function openDeleteModal(index) {
        itemToDelete = index;
        document.getElementById('delete-item-name').innerText = cart[index].name;
        deleteModal.classList.add('active');
    }

    window.closeDeleteModal = function() {
        deleteModal.classList.remove('active');
        itemToDelete = null;
        input.focus();
    }

    window.confirmDelete = function() {
        if (itemToDelete !== null) {
            cart.splice(itemToDelete, 1);
            renderCart();
            deleteModal.classList.remove('active');
            itemToDelete = null;
        }
        input.focus();
    }

    // Close modals on overlay click
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('active');
                input.focus();
            }
        });
    });

    // Close modals on ESC key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.classList.remove('active');
            });
            input.focus();
        }
    });

    // Initial render
    renderCart();
</script>
{% endblock %}